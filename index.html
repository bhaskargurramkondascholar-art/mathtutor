<script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ---------------------------------------------------------
        // ðŸ”´ CONFIGURATION SECTION
        // ---------------------------------------------------------
        const API_KEY = "AIzaSyBLgygpfESs05QFE19TSNDh8WSlELBOQh8";
        
        // I have removed the internal backticks ` from the text below so it doesn't break the code.
        const SYSTEM_INSTRUCTION = `
You are an expert Mathematics Tutor for Grade 8 students, specializing in Realistic Mathematics Education (RME).

Pedagogical Approach:
1. Context First: Never start with a formula. Start with a relatable, real-world scenario.
2. Guided Reinvention: Ask questions that lead the student to discover the rule themselves.
3. Interactivity: Give short prompts and wait for responses.
4. Visualizing: Encourage visualizing growth or scale.

Curriculum Scope (Grade 8):
- Powers with negative exponents.
- Laws of Exponents.
- Scientific Notation.

Interaction Guide:

Phase 1: The Hook
Offer a choice:
A: Paper Folding (Powers of 2)
B: Zombie/Bacteria Outbreak (Exponential multiplication)
C: Space Shrink Ray (Negative exponents)

Phase 2: Mathematization
Ask them to calculate steps manually. When numbers get big, introduce base^exponent notation.

Phase 3: Discovering Laws
Create situations for Product Law and Negative Exponents based on patterns.

Phase 4: Scientific Notation
Use context like distance to sun or red blood cells.

STORYBOOK MODE PROTOCOL:
Trigger: If user asks for a story/comic.
1. One Page at a Time.
2. Structure: Page Header (Page 1 of 5) -> Narrative (Max 60 words) -> [IMAGE DESCRIPTION] -> Math Challenge.
3. Visual Consistency: Describe images as "Vector illustration, clean lines, vibrant colors, educational storybook style." 
NOTE: You cannot generate actual images in this chat, so write [Generating Image: description...] as a placeholder text.

BRAINSTORMER MODE:
Trigger: User asks for project ideas.
Provide 3 creative ideas connecting Real World Scenarios to Exponents.

STEP 1: THE INTEREST CHECK (PERSONALIZATION)
Start every session by asking: "Welcome! What is your favorite hobby, video game, sport, or movie?"
Synthesize their answer into a math problem (e.g., Cricket runs doubling, Minecraft crafting).
`;
        // ---------------------------------------------------------

        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            systemInstruction: SYSTEM_INSTRUCTION
        });

        let chatHistory = [
            {
                role: "user",
                parts: [{ text: "Hello, start the session." }],
            },
            {
                role: "model",
                parts: [{ text: "Hello! I'm your Math Tutor. What is your favorite hobby? (Cricket, Gaming, Movies?)" }],
            },
        ];

        const chat = model.startChat({
            history: chatHistory,
        });

        // Make functions available globally
        window.sendMessage = async function() {
            const inputField = document.getElementById("userInput");
            const userText = inputField.value.trim();
            const chatBox = document.getElementById("chatBox");
            const loader = document.getElementById("loader");

            if (!userText) return;

            // 1. Add User Message to Screen
            chatBox.innerHTML += `<div class="message user-message">${userText}</div>`;
            inputField.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;
            loader.style.display = "block";

            try {
                // 2. Send to Gemini API
                const result = await chat.sendMessage(userText);
                const response = await result.response;
                const text = response.text();

                // 3. Format Text (NewLines + Bold)
                let formattedText = text
                    .replace(/\n/g, "<br>")
                    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>"); // This makes **bold** text work
                
                chatBox.innerHTML += `<div class="message ai-message">${formattedText}</div>`;
            } catch (error) {
                console.error(error);
                chatBox.innerHTML += `<div class="message ai-message" style="color:red">Error: ${error.message} (Check Console)</div>`;
            }

            loader.style.display = "none";
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.handleEnter = function(e) {
            if (e.key === 'Enter') sendMessage();
        }
    </script>
